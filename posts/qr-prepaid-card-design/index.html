<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><title>åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥</title>
<meta property="og:type" content="article"><meta property="og:url" content="https://zisai.com/posts/qr-prepaid-card-design/"><meta property="og:title" content="åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥"><meta property="og:description" content="æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚"><meta property="og:image" content="https://zisai.com/images/chuzhika.png"><meta property="og:image:alt" content="äºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥"><meta property="og:site_name" content="ç´«å¡ zisai.com"><meta property="article:published_time" content="2025-06-11T17:25:00+09:00"><meta property="article:modified_time" content="2025-06-11T17:25:00+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://zisai.com/posts/qr-prepaid-card-design/"><meta name=twitter:title content="åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥"><meta name=twitter:description content="æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚"><meta name=twitter:image content="https://zisai.com/images/chuzhika.png"><meta name=twitter:image:alt content="äºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥"><meta name=description content="æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚"><link rel=image_src href=https://zisai.com/images/chuzhika.png><meta name=format-detection content="telephone=no"><meta name=applicable-device content="mobile"><meta name=twitter:site content="ç´«å¡ zisai.com"><meta name=twitter:creator content="ç´«å¡ zisai.com"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image:type" content="image/jpeg"><meta name=weibo:title content="åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥"><meta name=weibo:description content="æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚"><meta name=weibo:image content="https://zisai.com/images/chuzhika.png"><meta name=keywords content><meta name=author content="ç´«å¡ zisai.com"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥ | ç´«å¡ zisai.com</title>
<meta name=keywords content="æ”¯ä»˜åˆ›æ–°,äºŒç»´ç ,å‚¨å€¼å¡,é‡‘èç§‘æŠ€"><meta name=description content="æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚"><meta name=author content="SHENNAN æ²ˆæ¥ "><link rel=canonical href=https://zisai.com/posts/qr-prepaid-card-design/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://zisai.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zisai.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zisai.com/favicon-32x32.png><link rel=apple-touch-icon href=https://zisai.com/apple-touch-icon.png><link rel=mask-icon href=https://zisai.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://zisai.com/posts/qr-prepaid-card-design/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=google-adsense-account content="ca-pub-6505236094995924"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-PCVR5FXN")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-WQ5LVXCGRZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WQ5LVXCGRZ")}</script><meta property="og:url" content="https://zisai.com/posts/qr-prepaid-card-design/"><meta property="og:site_name" content="ç´«å¡ zisai.com"><meta property="og:title" content="åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥"><meta property="og:description" content="æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-11T17:25:00+09:00"><meta property="article:modified_time" content="2025-06-11T17:25:00+09:00"><meta property="article:tag" content="æ”¯ä»˜åˆ›æ–°"><meta property="article:tag" content="äºŒç»´ç "><meta property="article:tag" content="å‚¨å€¼å¡"><meta property="article:tag" content="é‡‘èç§‘æŠ€"><meta property="og:image" content="https://zisai.com/images/chuzhika.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zisai.com/images/chuzhika.png"><meta name=twitter:title content="åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥"><meta name=twitter:description content="æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ–‡ç« ","item":"https://zisai.com/posts/"},{"@type":"ListItem","position":2,"name":"åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥","item":"https://zisai.com/posts/qr-prepaid-card-design/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥","name":"åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥","description":"æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚","keywords":["æ”¯ä»˜åˆ›æ–°","äºŒç»´ç ","å‚¨å€¼å¡","é‡‘èç§‘æŠ€"],"articleBody":"åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥ åœ¨é›¶å”®æ”¯ä»˜é¢†åŸŸï¼Œé¢„ä»˜è´¹å‚¨å€¼å¡ä¸€ç›´æ˜¯è¿æ¥æ¶ˆè´¹è€…ä¸å•†å®¶çš„æ¡¥æ¢ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿç£æ¡å¡æˆæœ¬é«˜ã€æ˜“æŸåï¼Œä¸”ä¾èµ–ä¸“ç”¨è¯»å¡è®¾å¤‡ï¼Œé™åˆ¶äº†å…¶çµæ´»æ€§ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬è®¾è®¡å¹¶æˆåŠŸæŠ•å…¥ä½¿ç”¨äº†ä¸€ç§åŸºäºäºŒç»´ç çš„å‚¨å€¼å¡ç³»ç»Ÿï¼Œæ˜¾è‘—é™ä½äº†æˆæœ¬ï¼Œæå‡äº†å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»è¿™ä¸€è®¾è®¡çš„æ ¸å¿ƒäº®ç‚¹ã€å·²å®ç°çš„åŠŸèƒ½ã€æœªæ¥çš„å‡çº§è®¡åˆ’ï¼Œä»¥åŠå¯¹é›¶å”®æ”¯ä»˜çš„å±•æœ›ã€‚\nå·²å®Œæˆçš„è®¾è®¡ï¼šä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡ æˆ‘ä»¬çš„äºŒç»´ç å‚¨å€¼å¡é’ˆå¯¹è¶…å¸‚åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå–ä»£äº†ä¼ ç»Ÿçš„ç£æ¡å¡ï¼Œå¸¦æ¥ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š\n1. æˆæœ¬ä¼˜åŒ– æ— ç£æ¡è®¾è®¡ï¼šé€šè¿‡å°åˆ·äºŒç»´ç æ›¿ä»£ç£æ¡ï¼Œæ¯å¼ å¡æˆæœ¬é™ä½30%ï¼Œå¹´èŠ‚çº¦æˆæœ¬åä½™ä¸‡å…ƒï¼Œè¾ƒä¸ºå¯è§‚ã€‚ ç®€åŒ–ç¡¬ä»¶éœ€æ±‚ï¼šæ— éœ€ç£æ¡è¯»å¡å™¨ï¼Œå•†å®¶ä»…éœ€æ”¯æŒäºŒç»´ç æ‰«æçš„POSæœºæˆ–æ‰‹æœºå³å¯å®Œæˆæ ¸é”€ï¼Œæ”¯æŒè·¨åœºæ™¯ä½¿ç”¨ï¼Œå¼‚ä¸šå•†å®¶å¯é€šè¿‡æ‰‹æœºAPPæ ¸é”€ã€‚ 2. å®‰å…¨ä¿éšœ æ ¸å¿ƒåŠ è§£å¯†æŠ€æœ¯ï¼šé‡‡ç”¨Golangå¼€å‘é«˜å¹¶å‘åŠ è§£å¯†ç®—æ³•ï¼Œæ”¯æŒæ¯ç§’å¤„ç†æ•°åƒç¬”äº¤æ˜“ã€‚å¯†é’¥ç®¡ç†æœªæ¥è®¡åˆ’é‡‡ç”¨ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆHSMï¼‰å­˜å‚¨ã€‚ä»¥ä¸‹æ˜¯æ”¯ä»˜äºŒç»´ç åŠ å¯†çš„æ ¸å¿ƒä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package crypto import ( \"crypto/cipher\" \"crypto/rand\" \"errors\" \"io\" ) // EncryptQRData encrypts card data (card number, amount) . func EncryptQRData(data, key []byte) (string, error) { block, err := XXX.NewCipher(key) if err != nil { return \"\", err } gcm, err := cipher.NewGCM(block) if err != nil { return \"\", err } nonce := make([]byte, gcm.NonceSize()) if _, err = io.ReadFull(rand.Reader, nonce); err != nil { return \"\", err } ciphertext := gcm.Seal(nonce, nonce, data, nil) return YYY.StdEncoding.EncodeToString(ciphertext), nil } // DecryptQRData decrypts the QR code data. func DecryptQRData(encodedData string, key []byte) ([]byte, error) { data, err := YYY.StdEncoding.DecodeString(encodedData) if err != nil { return nil, err } block, err := XXX.NewCipher(key) if err != nil { return nil, err } gcm, err := cipher.NewGCM(block) if err != nil { return nil, err } nonceSize := gcm.NonceSize() if len(data) \u003c nonceSize { return nil, errors.New(\"invalid ciphertext\") } nonce, ciphertext := data[:nonceSize], data[nonceSize:] return gcm.Open(nil, nonce, ciphertext, nil) } ä¸Šè¿°ä»£ç å®ç°äº†æ”¯ä»˜äºŒç»´ç çš„åŠ å¯†ä¸è§£å¯†ï¼Œç¡®ä¿æ•°æ®åœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§ã€‚æ ¸é”€ç³»ç»Ÿé€šè¿‡è§£å¯†è·å–å¡å·å’Œé‡‘é¢ï¼Œå®Œæˆæ”¯ä»˜ã€‚\næ”¯ä»˜äºŒç»´ç åŠ å¯†ï¼šæ”¯ä»˜äºŒç»´ç é‡‡ç”¨é«˜å¼ºåº¦åŠ å¯†åå†è¿›è¡ŒäºŒæ¬¡ç¼–ç ï¼Œè¦†ç›–åˆ®å¼€å±‚ï¼Œé˜²æ­¢æœªå”®å¡è¢«æ¶æ„æ‰«æã€‚\nåŠ¨æ€äºŒç»´ç æ”¯ä»˜ï¼šé€šè¿‡APPä¸ºæ¯ç¬”äº¤æ˜“ç”ŸæˆåŠ¨æ€äºŒç»´ç ï¼ˆåŸºäºæ—¶é—´æˆ³å’Œç”¨æˆ·IDï¼‰ï¼Œæœ‰æ•ˆæœŸä»…60ç§’ï¼Œç±»ä¼¼å¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ç ï¼Œé™ä½æ³„éœ²é£é™©ã€‚\nåŒé‡è®¤è¯ï¼šæ”¯ä»˜æ—¶è¦æ±‚ç”¨æˆ·è¾“å…¥6ä½PINç æˆ–é€šè¿‡APPè¿›è¡Œç”Ÿç‰©è¯†åˆ«ï¼ˆå¦‚æŒ‡çº¹ï¼‰ï¼Œç¡®ä¿äº¤æ˜“å®‰å…¨ã€‚ï¼ˆæœªæ‰§è¡Œã€‚å¾…æƒè¡¡æ•ˆç‡ä¸å®‰å…¨çš„äº’æ–¥æ€§ï¼‰\næœåŠ¡äºŒç»´ç ï¼šç”¨æˆ·æ‰«ææœåŠ¡äºŒç»´ç åï¼Œè¾“å…¥å¯†ç æŸ¥è¯¢ä½™é¢ã€‚æœåŠ¡ç ä¸ºå¯†æ–‡ï¼Œéœ€é€šè¿‡Golangç®—æ³•è§£å¯†åä¸æ ¸é”€ç³»ç»Ÿäº¤äº’ã€‚\n3. ç”¨æˆ·ä½“éªŒ ä¾¿æ·æŸ¥è¯¢ï¼šç”¨æˆ·é€šè¿‡æ‰«ææœåŠ¡äºŒç»´ç æˆ–ä½¿ç”¨ä¸“ç”¨APPå³å¯å®æ—¶æŸ¥è¯¢ä½™é¢ï¼Œæ— éœ€åˆ°åº—ã€‚ ç”µå­é’±åŒ…é›†æˆï¼šç”¨æˆ·å¯é€šè¿‡APPå°†å¡å†…ä½™é¢å……å€¼åˆ°ç”µå­é’±åŒ…ï¼Œæ”¯æŒçº¿ä¸Šçº¿ä¸‹æ¶ˆè´¹ã€‚ ç›´è§‚å¡é¢è®¾è®¡ï¼šå¡é¢åŒ…å«æ˜æ–‡å¡å·ï¼Œæ–¹ä¾¿ç”¨æˆ·è®°å½•ï¼Œåˆ®å¼€å±‚ä¸‹çš„æ”¯ä»˜äºŒç»´ç ä¿éšœå®‰å…¨æ€§ã€‚ è¿™ä¸€ç³»ç»Ÿå·²åœ¨è¿é”è¶…å¸‚æˆåŠŸè¿è¡Œï¼Œæ—¥å‡äº¤æ˜“é‡è¾¾æ•°ä¸‡ç¬”ï¼Œæ·±å—å•†å®¶å’Œæ¶ˆè´¹è€…å¥½è¯„ã€‚\næœªæ¥å‡çº§è®¾æƒ³ï¼šæ›´å®‰å…¨ã€æ›´æ™ºèƒ½ã€æ›´ç¯ä¿ å°½ç®¡å½“å‰è®¾è®¡å·²å–å¾—æ˜¾è‘—æˆæ•ˆï¼Œæˆ‘ä»¬ä»åœ¨æ¢ç´¢æ›´å¤šä¼˜åŒ–æ–¹å‘ï¼Œä»¥è¿›ä¸€æ­¥æå‡ç³»ç»Ÿçš„å®‰å…¨æ€§ã€ç”¨æˆ·ä½“éªŒå’Œå¯æŒç»­æ€§ã€‚\n1. å®‰å…¨æ€§å¢å¼º ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆHSMï¼‰é›†æˆï¼šè®¡åˆ’å¼•å…¥HSMï¼ˆå¦‚Thalesæˆ–Utimacoï¼‰å­˜å‚¨å¯†é’¥å¹¶æ‰§è¡Œè§£å¯†æ“ä½œï¼Œæå‡é«˜å³°æœŸæ€§èƒ½å¹¶é˜²æ­¢å¯†é’¥æ³„éœ²ã€‚ä»¥ä¸‹æ˜¯HSMé›†æˆçš„ä¼ªä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package hsm import ( \"crypto\" \"github.com/miekg/pkcs11\" ) type HSMClient struct { ctx *pkcs11.Ctx session pkcs11.SessionHandle } // InitHSM initializes the HSM connection. func (c *HSMClient) InitHSM(modulePath, pin string) error { c.ctx = pkcs11.New(modulePath) if c.ctx == nil { return errors.New(\"failed to load HSM module\") } err := c.ctx.Initialize() if err != nil { return err } slots, err := c.ctx.GetSlotList(true) if err != nil || len(slots) == 0 { return errors.New(\"no HSM slots available\") } c.session, err = c.ctx.OpenSession(slots[0], pkcs11.CKF_SERIAL_SESSION|pkcs11.CKF_RW_SESSION) if err != nil { return err } return c.ctx.Login(c.session, pkcs11.CKU_USER, pin) } // DecryptWithHSM decrypts data using the HSM-stored key. func (c *HSMClient) DecryptWithHSM(ciphertext []byte, keyHandle pkcs11.ObjectHandle) ([]byte, error) { mechanism := []*pkcs11.Mechanism{pkcs11.NewMechanism(pkcs11.CKM_XXX_GCM, nil)} err := c.ctx.DecryptInit(c.session, mechanism, keyHandle) if err != nil { return nil, err } return c.ctx.Decrypt(c.session, ciphertext) } ä¸Šè¿°ä¼ªä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡HSMè§£å¯†æ”¯ä»˜äºŒç»´ç æ•°æ®ï¼Œå¯†é’¥å­˜å‚¨åœ¨HSMä¸­ï¼Œå®‰å…¨æ€§æ›´é«˜ã€‚\né˜²ä¼ªæŠ€æœ¯å‡çº§ï¼šåœ¨å¡é¢äºŒç»´ç ä¸Šå åŠ å…¨æ¯é˜²ä¼ªå›¾æ¡ˆæˆ–å¾®å‹æ ‡è®°ã€‚ï¼ˆå¾…è€ƒè™‘æˆæœ¬ï¼‰\nç¦»çº¿æ”¯ä»˜æ”¯æŒï¼šå¼€å‘åŸºäºæ—¶é—´æˆ³çš„ä¸´æ—¶å¯†é’¥æœºåˆ¶ï¼Œå…è®¸åœ¨ç½‘ç»œä¸ç¨³å®šæ—¶å®Œæˆæ ¸é”€ï¼Œç®—æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 // GenerateOfflineToken generates a temporary token for offline payment. func GenerateOfflineToken(cardID string, timestamp int64, secret []byte) string { data := fmt.Sprintf(\"%s:%d\", cardID, timestamp) h := hmac.New(sha256.New, secret) h.Write([]byte(data)) return YYY.StdEncoding.EncodeToString(h.Sum(nil)) } 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ– å°ç¨‹åºå…¥å£ï¼šæ¨å‡ºå¾®ä¿¡å°ç¨‹åºæˆ–çŸ­é“¾æ¥ï¼Œç”¨æˆ·æ— éœ€ä¸‹è½½APPå³å¯æŸ¥è¯¢ä½™é¢æˆ–å……å€¼ï¼Œé™ä½ä½¿ç”¨é—¨æ§›ã€‚ æ— å¡å·è®¾è®¡ï¼šéšè—æ˜æ–‡å¡å·ï¼Œä»…åœ¨APPæˆ–æ ¸é”€ç³»ç»Ÿæ˜¾ç¤ºéƒ¨åˆ†å¡å·ï¼ˆå¦‚å4ä½ï¼‰ï¼Œä¿æŠ¤ç”¨æˆ·éšç§ã€‚ çº¿ä¸‹å…¼å®¹æ€§ï¼šä¸ºä¸æ”¯æŒäºŒç»´ç çš„æ—§POSæœºæä¾›å¤‡ç”¨æ–¹æ¡ˆï¼Œå¦‚é€šè¿‡NFCæ¨¡æ‹Ÿç£æ¡å¡ã€‚ 3. å¯æŒç»­æ€§ä¸æˆæœ¬ ç”µå­å¡æ¨å¹¿ï¼šé¼“åŠ±ç”¨æˆ·ä½¿ç”¨çº¯ç”µå­å‚¨å€¼å¡ï¼Œé€šè¿‡APPæˆ–å°ç¨‹åºå‘æ”¾ï¼Œå‡å°‘å®ä½“å¡ç”Ÿäº§ï¼Œé™ä½ç¯å¢ƒå½±å“ã€‚ ç¯ä¿ææ–™ï¼šé‡‡ç”¨å¯é™è§£æˆ–å¯å›æ”¶ææ–™åˆ¶ä½œå®ä½“å¡ï¼Œå“åº”ç»¿è‰²æ¶ˆè´¹è¶‹åŠ¿ã€‚ è§„æ¨¡æ•ˆåº”ï¼šé€šè¿‡æ‰¹é‡ç”Ÿäº§å°†å•å¼ å¡æˆæœ¬è¿›ä¸€æ­¥é™ä½ã€‚ï¼ˆåŸæˆæœ¬çš„50%ä»¥ä¸‹ï¼‰ã€‚ 4. æ™ºèƒ½åŒ–ä¸ç”Ÿæ€æ‰©å±• æ•°æ®é©±åŠ¨ï¼šåˆ©ç”¨APPæ”¶é›†ç”¨æˆ·æ¶ˆè´¹æ•°æ®ï¼Œæ¨é€ä¸ªæ€§åŒ–ä¼˜æƒ ï¼Œæå‡å¤è´­ç‡ã€‚ åŒºå—é“¾æŠ€æœ¯ï¼šæ¢ç´¢åŒºå—é“¾è®°å½•ä½™é¢å’Œäº¤æ˜“ï¼Œå¢å¼ºé€æ˜åº¦å’Œé˜²ç¯¡æ”¹èƒ½åŠ›ã€‚ ARäº’åŠ¨ï¼šåœ¨APPä¸­åŠ å…¥ARåŠŸèƒ½ï¼Œæ‰«æå¡é¢äºŒç»´ç å¯å±•ç¤ºä¼˜æƒ æˆ–äº’åŠ¨æ¸¸æˆï¼Œå¢åŠ ç”¨æˆ·ç²˜æ€§ã€‚ è·¨å“ç‰Œåˆä½œï¼šæ‰“é€ é€šç”¨å‚¨å€¼å¡ç”Ÿæ€ï¼Œä¸é¤é¥®ã€å¨±ä¹ç­‰è¡Œä¸šåˆä½œï¼Œæ‰©å±•ä½¿ç”¨åœºæ™¯ã€‚ æœªæ¥å±•æœ›ï¼šæ•°å­—åŒ–æ”¯ä»˜çš„æ— é™å¯èƒ½ äºŒç»´ç å‚¨å€¼å¡çš„æˆåŠŸè½åœ°æ ‡å¿—ç€é›¶å”®æ”¯ä»˜å‘ä½æˆæœ¬ã€æ•°å­—åŒ–æ–¹å‘è¿ˆå‡ºäº†é‡è¦ä¸€æ­¥ã€‚æœªæ¥ï¼Œéšç€5Gã€ç‰©è”ç½‘å’ŒåŒºå—é“¾æŠ€æœ¯çš„æ™®åŠï¼Œæˆ‘ä»¬ç›¸ä¿¡æ”¯ä»˜ç³»ç»Ÿå°†æ›´åŠ æ™ºèƒ½åŒ–å’Œæ— ç¼åŒ–ï¼š\nå…¨åœºæ™¯æ”¯ä»˜ï¼šå‚¨å€¼å¡å°†æˆä¸ºè·¨è¡Œä¸šï¼ˆé¤é¥®ã€å¨±ä¹ã€äº¤é€šï¼‰çš„é€šç”¨æ”¯ä»˜å·¥å…·ã€‚ æ— æ„Ÿæ”¯ä»˜ï¼šç»“åˆNFCå’Œç”Ÿç‰©è¯†åˆ«æŠ€æœ¯ï¼Œç”¨æˆ·åªéœ€é è¿‘è®¾å¤‡å³å¯å®Œæˆæ”¯ä»˜ã€‚ ç»¿è‰²é‡‘èï¼šé€šè¿‡ç”µå­å¡å’Œç¯ä¿ææ–™ï¼Œå‚¨å€¼å¡ç³»ç»Ÿå°†ä¸ºå¯æŒç»­å‘å±•è´¡çŒ®åŠ›é‡ã€‚ æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰“é€ ä¸€ä¸ªå®‰å…¨ã€ä¾¿æ·ã€å¯æŒç»­çš„æ”¯ä»˜ç”Ÿæ€ï¼Œè®©æ¯ä¸€ä½æ¶ˆè´¹è€…éƒ½èƒ½äº«å—åˆ°æ•°å­—åŒ–å¸¦æ¥çš„ä¾¿åˆ©ï¼ŒåŒæ—¶ä¸ºå•†å®¶åˆ›é€ æ›´å¤§ä»·å€¼ã€‚\nç»“è¯­\nä»ç£æ¡åˆ°äºŒç»´ç ï¼Œä»å®ä½“å¡åˆ°ç”µå­é’±åŒ…ï¼Œæˆ‘ä»¬çš„å‚¨å€¼å¡è®¾è®¡æ­£åœ¨é‡å¡‘é›¶å”®æ”¯ä»˜çš„æœªæ¥ã€‚æˆ‘ä»¬æœŸå¾…é€šè¿‡æŒç»­åˆ›æ–°ï¼Œè®©æ”¯ä»˜æ›´ç®€å•ã€æ›´å®‰å…¨ã€æ›´æ™ºèƒ½ã€‚æ¬¢è¿ä½“éªŒè¿™ä¸€å…¨æ–°æ”¯ä»˜æ–¹å¼ï¼\n","wordCount":"2292","inLanguage":"zh-cn","image":"https://zisai.com/images/chuzhika.png","datePublished":"2025-06-11T17:25:00+09:00","dateModified":"2025-06-11T17:25:00+09:00","author":{"@type":"Person","name":"SHENNAN æ²ˆæ¥ "},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zisai.com/posts/qr-prepaid-card-design/"},"publisher":{"@type":"Organization","name":"ç´«å¡ zisai.com","logo":{"@type":"ImageObject","url":"https://zisai.com/favicon.ico"}}}</script></head><body id=top><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PCVR5FXN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zisai.com/ accesskey=h title="ç´«å¡ zisai.com (Alt + H)">ç´«å¡ zisai.com</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zisai.com/search/ title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li><a href=https://zisai.com/posts/ title=æ–‡ç« ><span>ğŸ“š æ–‡ç« </span></a></li><li><a href=https://zisai.com/archives/ title=æ•…äº‹><span>ğŸ—‚ï¸ æ•…äº‹</span></a></li><li><a href=https://zisai.com/tags/ title=æ ‡ç­¾><span>ğŸ”– æ ‡ç­¾</span></a></li><li><a href=https://zisai.com/about/ title="â„¹ï¸ å…³äº"><span>â„¹ï¸ å…³äº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zisai.com/>Home</a>&nbsp;Â»&nbsp;<a href=https://zisai.com/posts/>æ–‡ç« </a></div><h1 class="post-title entry-hint-parent">åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥</h1><div class=post-description>æ¢ç´¢ä¸€ç§ä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡è®¾è®¡ï¼Œç»“åˆåŠ¨æ€æ”¯ä»˜ç å’ŒåŒé‡è®¤è¯ï¼Œå±•æœ›é›¶å”®æ”¯ä»˜çš„æ•°å­—åŒ–æœªæ¥ã€‚</div><div class=post-meta><span title='2025-06-11 17:25:00 +0900 +0900'>2025-06-11</span>&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;SHENNAN æ²ˆæ¥ </div></header><figure class=entry-cover><img loading=eager src=https://zisai.com/images/chuzhika.png alt=äºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%88%9b%e6%96%b0%e6%94%af%e4%bb%98%e4%bd%93%e9%aa%8c%e4%ba%8c%e7%bb%b4%e7%a0%81%e5%82%a8%e5%80%bc%e5%8d%a1%e7%9a%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%9c%aa%e6%9d%a5 aria-label=åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥>åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥</a><ul><li><a href=#%e5%b7%b2%e5%ae%8c%e6%88%90%e7%9a%84%e8%ae%be%e8%ae%a1%e4%bd%8e%e6%88%90%e6%9c%ac%e9%ab%98%e5%ae%89%e5%85%a8%e7%9a%84%e4%ba%8c%e7%bb%b4%e7%a0%81%e5%82%a8%e5%80%bc%e5%8d%a1 aria-label=å·²å®Œæˆçš„è®¾è®¡ï¼šä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡>å·²å®Œæˆçš„è®¾è®¡ï¼šä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡</a><ul><li><a href=#1-%e6%88%90%e6%9c%ac%e4%bc%98%e5%8c%96 aria-label="1. æˆæœ¬ä¼˜åŒ–">1. æˆæœ¬ä¼˜åŒ–</a></li><li><a href=#2-%e5%ae%89%e5%85%a8%e4%bf%9d%e9%9a%9c aria-label="2. å®‰å…¨ä¿éšœ">2. å®‰å…¨ä¿éšœ</a></li><li><a href=#3-%e7%94%a8%e6%88%b7%e4%bd%93%e9%aa%8c aria-label="3. ç”¨æˆ·ä½“éªŒ">3. ç”¨æˆ·ä½“éªŒ</a></li></ul></li><li><a href=#%e6%9c%aa%e6%9d%a5%e5%8d%87%e7%ba%a7%e8%ae%be%e6%83%b3%e6%9b%b4%e5%ae%89%e5%85%a8%e6%9b%b4%e6%99%ba%e8%83%bd%e6%9b%b4%e7%8e%af%e4%bf%9d aria-label=æœªæ¥å‡çº§è®¾æƒ³ï¼šæ›´å®‰å…¨ã€æ›´æ™ºèƒ½ã€æ›´ç¯ä¿>æœªæ¥å‡çº§è®¾æƒ³ï¼šæ›´å®‰å…¨ã€æ›´æ™ºèƒ½ã€æ›´ç¯ä¿</a><ul><li><a href=#1-%e5%ae%89%e5%85%a8%e6%80%a7%e5%a2%9e%e5%bc%ba aria-label="1. å®‰å…¨æ€§å¢å¼º">1. å®‰å…¨æ€§å¢å¼º</a></li><li><a href=#2-%e7%94%a8%e6%88%b7%e4%bd%93%e9%aa%8c%e4%bc%98%e5%8c%96 aria-label="2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–">2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–</a></li><li><a href=#3-%e5%8f%af%e6%8c%81%e7%bb%ad%e6%80%a7%e4%b8%8e%e6%88%90%e6%9c%ac aria-label="3. å¯æŒç»­æ€§ä¸æˆæœ¬">3. å¯æŒç»­æ€§ä¸æˆæœ¬</a></li><li><a href=#4-%e6%99%ba%e8%83%bd%e5%8c%96%e4%b8%8e%e7%94%9f%e6%80%81%e6%89%a9%e5%b1%95 aria-label="4. æ™ºèƒ½åŒ–ä¸ç”Ÿæ€æ‰©å±•">4. æ™ºèƒ½åŒ–ä¸ç”Ÿæ€æ‰©å±•</a></li></ul></li><li><a href=#%e6%9c%aa%e6%9d%a5%e5%b1%95%e6%9c%9b%e6%95%b0%e5%ad%97%e5%8c%96%e6%94%af%e4%bb%98%e7%9a%84%e6%97%a0%e9%99%90%e5%8f%af%e8%83%bd aria-label=æœªæ¥å±•æœ›ï¼šæ•°å­—åŒ–æ”¯ä»˜çš„æ— é™å¯èƒ½>æœªæ¥å±•æœ›ï¼šæ•°å­—åŒ–æ”¯ä»˜çš„æ— é™å¯èƒ½</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=åˆ›æ–°æ”¯ä»˜ä½“éªŒäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥>åˆ›æ–°æ”¯ä»˜ä½“éªŒï¼šäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥<a hidden class=anchor aria-hidden=true href=#åˆ›æ–°æ”¯ä»˜ä½“éªŒäºŒç»´ç å‚¨å€¼å¡çš„è®¾è®¡ä¸æœªæ¥>#</a></h1><p>åœ¨é›¶å”®æ”¯ä»˜é¢†åŸŸï¼Œé¢„ä»˜è´¹å‚¨å€¼å¡ä¸€ç›´æ˜¯è¿æ¥æ¶ˆè´¹è€…ä¸å•†å®¶çš„æ¡¥æ¢ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿç£æ¡å¡æˆæœ¬é«˜ã€æ˜“æŸåï¼Œä¸”ä¾èµ–ä¸“ç”¨è¯»å¡è®¾å¤‡ï¼Œé™åˆ¶äº†å…¶çµæ´»æ€§ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬è®¾è®¡å¹¶æˆåŠŸæŠ•å…¥ä½¿ç”¨äº†ä¸€ç§åŸºäºäºŒç»´ç çš„å‚¨å€¼å¡ç³»ç»Ÿï¼Œæ˜¾è‘—é™ä½äº†æˆæœ¬ï¼Œæå‡äº†å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»è¿™ä¸€è®¾è®¡çš„æ ¸å¿ƒäº®ç‚¹ã€å·²å®ç°çš„åŠŸèƒ½ã€æœªæ¥çš„å‡çº§è®¡åˆ’ï¼Œä»¥åŠå¯¹é›¶å”®æ”¯ä»˜çš„å±•æœ›ã€‚</p><h2 id=å·²å®Œæˆçš„è®¾è®¡ä½æˆæœ¬é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡>å·²å®Œæˆçš„è®¾è®¡ï¼šä½æˆæœ¬ã€é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡<a hidden class=anchor aria-hidden=true href=#å·²å®Œæˆçš„è®¾è®¡ä½æˆæœ¬é«˜å®‰å…¨çš„äºŒç»´ç å‚¨å€¼å¡>#</a></h2><p>æˆ‘ä»¬çš„äºŒç»´ç å‚¨å€¼å¡é’ˆå¯¹è¶…å¸‚åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå–ä»£äº†ä¼ ç»Ÿçš„ç£æ¡å¡ï¼Œå¸¦æ¥ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š</p><h3 id=1-æˆæœ¬ä¼˜åŒ–>1. <strong>æˆæœ¬ä¼˜åŒ–</strong><a hidden class=anchor aria-hidden=true href=#1-æˆæœ¬ä¼˜åŒ–>#</a></h3><ul><li><strong>æ— ç£æ¡è®¾è®¡</strong>ï¼šé€šè¿‡å°åˆ·äºŒç»´ç æ›¿ä»£ç£æ¡ï¼Œæ¯å¼ å¡æˆæœ¬é™ä½30%ï¼Œå¹´èŠ‚çº¦æˆæœ¬åä½™ä¸‡å…ƒï¼Œè¾ƒä¸ºå¯è§‚ã€‚</li><li><strong>ç®€åŒ–ç¡¬ä»¶éœ€æ±‚</strong>ï¼šæ— éœ€ç£æ¡è¯»å¡å™¨ï¼Œå•†å®¶ä»…éœ€æ”¯æŒäºŒç»´ç æ‰«æçš„POSæœºæˆ–æ‰‹æœºå³å¯å®Œæˆæ ¸é”€ï¼Œæ”¯æŒè·¨åœºæ™¯ä½¿ç”¨ï¼Œå¼‚ä¸šå•†å®¶å¯é€šè¿‡æ‰‹æœºAPPæ ¸é”€ã€‚</li></ul><h3 id=2-å®‰å…¨ä¿éšœ>2. <strong>å®‰å…¨ä¿éšœ</strong><a hidden class=anchor aria-hidden=true href=#2-å®‰å…¨ä¿éšœ>#</a></h3><ul><li><p><strong>æ ¸å¿ƒåŠ è§£å¯†æŠ€æœ¯</strong>ï¼šé‡‡ç”¨Golangå¼€å‘é«˜å¹¶å‘åŠ è§£å¯†ç®—æ³•ï¼Œæ”¯æŒæ¯ç§’å¤„ç†æ•°åƒç¬”äº¤æ˜“ã€‚å¯†é’¥ç®¡ç†æœªæ¥è®¡åˆ’é‡‡ç”¨ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆHSMï¼‰å­˜å‚¨ã€‚ä»¥ä¸‹æ˜¯æ”¯ä»˜äºŒç»´ç åŠ å¯†çš„æ ¸å¿ƒä»£ç ç¤ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>crypto</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/cipher&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/rand&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// EncryptQRData encrypts card data (card number, amount) .</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>EncryptQRData</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>key</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>block</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>XXX</span><span class=p>.</span><span class=nf>NewCipher</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>gcm</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cipher</span><span class=p>.</span><span class=nf>NewGCM</span><span class=p>(</span><span class=nx>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>nonce</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>gcm</span><span class=p>.</span><span class=nf>NonceSize</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadFull</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nx>Reader</span><span class=p>,</span> <span class=nx>nonce</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>ciphertext</span> <span class=o>:=</span> <span class=nx>gcm</span><span class=p>.</span><span class=nf>Seal</span><span class=p>(</span><span class=nx>nonce</span><span class=p>,</span> <span class=nx>nonce</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>YYY</span><span class=p>.</span><span class=nx>StdEncoding</span><span class=p>.</span><span class=nf>EncodeToString</span><span class=p>(</span><span class=nx>ciphertext</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DecryptQRData decrypts the QR code data.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>DecryptQRData</span><span class=p>(</span><span class=nx>encodedData</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>key</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>YYY</span><span class=p>.</span><span class=nx>StdEncoding</span><span class=p>.</span><span class=nf>DecodeString</span><span class=p>(</span><span class=nx>encodedData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>block</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>XXX</span><span class=p>.</span><span class=nf>NewCipher</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>gcm</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cipher</span><span class=p>.</span><span class=nf>NewGCM</span><span class=p>(</span><span class=nx>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>nonceSize</span> <span class=o>:=</span> <span class=nx>gcm</span><span class=p>.</span><span class=nf>NonceSize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>nonceSize</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;invalid ciphertext&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>nonce</span><span class=p>,</span> <span class=nx>ciphertext</span> <span class=o>:=</span> <span class=nx>data</span><span class=p>[:</span><span class=nx>nonceSize</span><span class=p>],</span> <span class=nx>data</span><span class=p>[</span><span class=nx>nonceSize</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>gcm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=nx>nonce</span><span class=p>,</span> <span class=nx>ciphertext</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°ä»£ç å®ç°äº†æ”¯ä»˜äºŒç»´ç çš„åŠ å¯†ä¸è§£å¯†ï¼Œç¡®ä¿æ•°æ®åœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§ã€‚æ ¸é”€ç³»ç»Ÿé€šè¿‡è§£å¯†è·å–å¡å·å’Œé‡‘é¢ï¼Œå®Œæˆæ”¯ä»˜ã€‚</p></li><li><p><strong>æ”¯ä»˜äºŒç»´ç åŠ å¯†</strong>ï¼šæ”¯ä»˜äºŒç»´ç é‡‡ç”¨é«˜å¼ºåº¦åŠ å¯†åå†è¿›è¡ŒäºŒæ¬¡ç¼–ç ï¼Œè¦†ç›–åˆ®å¼€å±‚ï¼Œé˜²æ­¢æœªå”®å¡è¢«æ¶æ„æ‰«æã€‚</p></li><li><p><strong>åŠ¨æ€äºŒç»´ç æ”¯ä»˜</strong>ï¼šé€šè¿‡APPä¸ºæ¯ç¬”äº¤æ˜“ç”ŸæˆåŠ¨æ€äºŒç»´ç ï¼ˆåŸºäºæ—¶é—´æˆ³å’Œç”¨æˆ·IDï¼‰ï¼Œæœ‰æ•ˆæœŸä»…60ç§’ï¼Œç±»ä¼¼å¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ç ï¼Œé™ä½æ³„éœ²é£é™©ã€‚</p></li><li><p><strong>åŒé‡è®¤è¯</strong>ï¼šæ”¯ä»˜æ—¶è¦æ±‚ç”¨æˆ·è¾“å…¥6ä½PINç æˆ–é€šè¿‡APPè¿›è¡Œç”Ÿç‰©è¯†åˆ«ï¼ˆå¦‚æŒ‡çº¹ï¼‰ï¼Œç¡®ä¿äº¤æ˜“å®‰å…¨ã€‚ï¼ˆæœªæ‰§è¡Œã€‚å¾…æƒè¡¡æ•ˆç‡ä¸å®‰å…¨çš„äº’æ–¥æ€§ï¼‰</p></li><li><p><strong>æœåŠ¡äºŒç»´ç </strong>ï¼šç”¨æˆ·æ‰«ææœåŠ¡äºŒç»´ç åï¼Œè¾“å…¥å¯†ç æŸ¥è¯¢ä½™é¢ã€‚æœåŠ¡ç ä¸ºå¯†æ–‡ï¼Œéœ€é€šè¿‡Golangç®—æ³•è§£å¯†åä¸æ ¸é”€ç³»ç»Ÿäº¤äº’ã€‚</p></li></ul><h3 id=3-ç”¨æˆ·ä½“éªŒ>3. <strong>ç”¨æˆ·ä½“éªŒ</strong><a hidden class=anchor aria-hidden=true href=#3-ç”¨æˆ·ä½“éªŒ>#</a></h3><ul><li><strong>ä¾¿æ·æŸ¥è¯¢</strong>ï¼šç”¨æˆ·é€šè¿‡æ‰«ææœåŠ¡äºŒç»´ç æˆ–ä½¿ç”¨ä¸“ç”¨APPå³å¯å®æ—¶æŸ¥è¯¢ä½™é¢ï¼Œæ— éœ€åˆ°åº—ã€‚</li><li><strong>ç”µå­é’±åŒ…é›†æˆ</strong>ï¼šç”¨æˆ·å¯é€šè¿‡APPå°†å¡å†…ä½™é¢å……å€¼åˆ°ç”µå­é’±åŒ…ï¼Œæ”¯æŒçº¿ä¸Šçº¿ä¸‹æ¶ˆè´¹ã€‚</li><li><strong>ç›´è§‚å¡é¢è®¾è®¡</strong>ï¼šå¡é¢åŒ…å«æ˜æ–‡å¡å·ï¼Œæ–¹ä¾¿ç”¨æˆ·è®°å½•ï¼Œåˆ®å¼€å±‚ä¸‹çš„æ”¯ä»˜äºŒç»´ç ä¿éšœå®‰å…¨æ€§ã€‚</li></ul><p>è¿™ä¸€ç³»ç»Ÿå·²åœ¨è¿é”è¶…å¸‚æˆåŠŸè¿è¡Œï¼Œæ—¥å‡äº¤æ˜“é‡è¾¾æ•°ä¸‡ç¬”ï¼Œæ·±å—å•†å®¶å’Œæ¶ˆè´¹è€…å¥½è¯„ã€‚</p><h2 id=æœªæ¥å‡çº§è®¾æƒ³æ›´å®‰å…¨æ›´æ™ºèƒ½æ›´ç¯ä¿>æœªæ¥å‡çº§è®¾æƒ³ï¼šæ›´å®‰å…¨ã€æ›´æ™ºèƒ½ã€æ›´ç¯ä¿<a hidden class=anchor aria-hidden=true href=#æœªæ¥å‡çº§è®¾æƒ³æ›´å®‰å…¨æ›´æ™ºèƒ½æ›´ç¯ä¿>#</a></h2><p>å°½ç®¡å½“å‰è®¾è®¡å·²å–å¾—æ˜¾è‘—æˆæ•ˆï¼Œæˆ‘ä»¬ä»åœ¨æ¢ç´¢æ›´å¤šä¼˜åŒ–æ–¹å‘ï¼Œä»¥è¿›ä¸€æ­¥æå‡ç³»ç»Ÿçš„å®‰å…¨æ€§ã€ç”¨æˆ·ä½“éªŒå’Œå¯æŒç»­æ€§ã€‚</p><h3 id=1-å®‰å…¨æ€§å¢å¼º>1. <strong>å®‰å…¨æ€§å¢å¼º</strong><a hidden class=anchor aria-hidden=true href=#1-å®‰å…¨æ€§å¢å¼º>#</a></h3><ul><li><p><strong>ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆHSMï¼‰é›†æˆ</strong>ï¼šè®¡åˆ’å¼•å…¥HSMï¼ˆå¦‚Thalesæˆ–Utimacoï¼‰å­˜å‚¨å¯†é’¥å¹¶æ‰§è¡Œè§£å¯†æ“ä½œï¼Œæå‡é«˜å³°æœŸæ€§èƒ½å¹¶é˜²æ­¢å¯†é’¥æ³„éœ²ã€‚ä»¥ä¸‹æ˜¯HSMé›†æˆçš„ä¼ªä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>hsm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/miekg/pkcs11&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>HSMClient</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>*</span><span class=nx>pkcs11</span><span class=p>.</span><span class=nx>Ctx</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span> <span class=nx>pkcs11</span><span class=p>.</span><span class=nx>SessionHandle</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// InitHSM initializes the HSM connection.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>HSMClient</span><span class=p>)</span> <span class=nf>InitHSM</span><span class=p>(</span><span class=nx>modulePath</span><span class=p>,</span> <span class=nx>pin</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span> <span class=p>=</span> <span class=nx>pkcs11</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>modulePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;failed to load HSM module&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Initialize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>slots</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>GetSlotList</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>slots</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;no HSM slots available&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>session</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>OpenSession</span><span class=p>(</span><span class=nx>slots</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>pkcs11</span><span class=p>.</span><span class=nx>CKF_SERIAL_SESSION</span><span class=p>|</span><span class=nx>pkcs11</span><span class=p>.</span><span class=nx>CKF_RW_SESSION</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Login</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>session</span><span class=p>,</span> <span class=nx>pkcs11</span><span class=p>.</span><span class=nx>CKU_USER</span><span class=p>,</span> <span class=nx>pin</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DecryptWithHSM decrypts data using the HSM-stored key.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>HSMClient</span><span class=p>)</span> <span class=nf>DecryptWithHSM</span><span class=p>(</span><span class=nx>ciphertext</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>keyHandle</span> <span class=nx>pkcs11</span><span class=p>.</span><span class=nx>ObjectHandle</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mechanism</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pkcs11</span><span class=p>.</span><span class=nx>Mechanism</span><span class=p>{</span><span class=nx>pkcs11</span><span class=p>.</span><span class=nf>NewMechanism</span><span class=p>(</span><span class=nx>pkcs11</span><span class=p>.</span><span class=nx>CKM_XXX_GCM</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>DecryptInit</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>session</span><span class=p>,</span> <span class=nx>mechanism</span><span class=p>,</span> <span class=nx>keyHandle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Decrypt</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>session</span><span class=p>,</span> <span class=nx>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°ä¼ªä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡HSMè§£å¯†æ”¯ä»˜äºŒç»´ç æ•°æ®ï¼Œå¯†é’¥å­˜å‚¨åœ¨HSMä¸­ï¼Œå®‰å…¨æ€§æ›´é«˜ã€‚</p></li><li><p><strong>é˜²ä¼ªæŠ€æœ¯å‡çº§</strong>ï¼šåœ¨å¡é¢äºŒç»´ç ä¸Šå åŠ å…¨æ¯é˜²ä¼ªå›¾æ¡ˆæˆ–å¾®å‹æ ‡è®°ã€‚ï¼ˆå¾…è€ƒè™‘æˆæœ¬ï¼‰</p></li><li><p><strong>ç¦»çº¿æ”¯ä»˜æ”¯æŒ</strong>ï¼šå¼€å‘åŸºäºæ—¶é—´æˆ³çš„ä¸´æ—¶å¯†é’¥æœºåˆ¶ï¼Œå…è®¸åœ¨ç½‘ç»œä¸ç¨³å®šæ—¶å®Œæˆæ ¸é”€ï¼Œç®—æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// GenerateOfflineToken generates a temporary token for offline payment.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GenerateOfflineToken</span><span class=p>(</span><span class=nx>cardID</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>timestamp</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>secret</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%d&#34;</span><span class=p>,</span> <span class=nx>cardID</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>h</span> <span class=o>:=</span> <span class=nx>hmac</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>sha256</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span> <span class=nx>secret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>h</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>YYY</span><span class=p>.</span><span class=nx>StdEncoding</span><span class=p>.</span><span class=nf>EncodeToString</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nf>Sum</span><span class=p>(</span><span class=kc>nil</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=2-ç”¨æˆ·ä½“éªŒä¼˜åŒ–>2. <strong>ç”¨æˆ·ä½“éªŒä¼˜åŒ–</strong><a hidden class=anchor aria-hidden=true href=#2-ç”¨æˆ·ä½“éªŒä¼˜åŒ–>#</a></h3><ul><li><strong>å°ç¨‹åºå…¥å£</strong>ï¼šæ¨å‡ºå¾®ä¿¡å°ç¨‹åºæˆ–çŸ­é“¾æ¥ï¼Œç”¨æˆ·æ— éœ€ä¸‹è½½APPå³å¯æŸ¥è¯¢ä½™é¢æˆ–å……å€¼ï¼Œé™ä½ä½¿ç”¨é—¨æ§›ã€‚</li><li><strong>æ— å¡å·è®¾è®¡</strong>ï¼šéšè—æ˜æ–‡å¡å·ï¼Œä»…åœ¨APPæˆ–æ ¸é”€ç³»ç»Ÿæ˜¾ç¤ºéƒ¨åˆ†å¡å·ï¼ˆå¦‚å4ä½ï¼‰ï¼Œä¿æŠ¤ç”¨æˆ·éšç§ã€‚</li><li><strong>çº¿ä¸‹å…¼å®¹æ€§</strong>ï¼šä¸ºä¸æ”¯æŒäºŒç»´ç çš„æ—§POSæœºæä¾›å¤‡ç”¨æ–¹æ¡ˆï¼Œå¦‚é€šè¿‡NFCæ¨¡æ‹Ÿç£æ¡å¡ã€‚</li></ul><h3 id=3-å¯æŒç»­æ€§ä¸æˆæœ¬>3. <strong>å¯æŒç»­æ€§ä¸æˆæœ¬</strong><a hidden class=anchor aria-hidden=true href=#3-å¯æŒç»­æ€§ä¸æˆæœ¬>#</a></h3><ul><li><strong>ç”µå­å¡æ¨å¹¿</strong>ï¼šé¼“åŠ±ç”¨æˆ·ä½¿ç”¨çº¯ç”µå­å‚¨å€¼å¡ï¼Œé€šè¿‡APPæˆ–å°ç¨‹åºå‘æ”¾ï¼Œå‡å°‘å®ä½“å¡ç”Ÿäº§ï¼Œé™ä½ç¯å¢ƒå½±å“ã€‚</li><li><strong>ç¯ä¿ææ–™</strong>ï¼šé‡‡ç”¨å¯é™è§£æˆ–å¯å›æ”¶ææ–™åˆ¶ä½œå®ä½“å¡ï¼Œå“åº”ç»¿è‰²æ¶ˆè´¹è¶‹åŠ¿ã€‚</li><li><strong>è§„æ¨¡æ•ˆåº”</strong>ï¼šé€šè¿‡æ‰¹é‡ç”Ÿäº§å°†å•å¼ å¡æˆæœ¬è¿›ä¸€æ­¥é™ä½ã€‚ï¼ˆåŸæˆæœ¬çš„50%ä»¥ä¸‹ï¼‰ã€‚</li></ul><h3 id=4-æ™ºèƒ½åŒ–ä¸ç”Ÿæ€æ‰©å±•>4. <strong>æ™ºèƒ½åŒ–ä¸ç”Ÿæ€æ‰©å±•</strong><a hidden class=anchor aria-hidden=true href=#4-æ™ºèƒ½åŒ–ä¸ç”Ÿæ€æ‰©å±•>#</a></h3><ul><li><strong>æ•°æ®é©±åŠ¨</strong>ï¼šåˆ©ç”¨APPæ”¶é›†ç”¨æˆ·æ¶ˆè´¹æ•°æ®ï¼Œæ¨é€ä¸ªæ€§åŒ–ä¼˜æƒ ï¼Œæå‡å¤è´­ç‡ã€‚</li><li><strong>åŒºå—é“¾æŠ€æœ¯</strong>ï¼šæ¢ç´¢åŒºå—é“¾è®°å½•ä½™é¢å’Œäº¤æ˜“ï¼Œå¢å¼ºé€æ˜åº¦å’Œé˜²ç¯¡æ”¹èƒ½åŠ›ã€‚</li><li><strong>ARäº’åŠ¨</strong>ï¼šåœ¨APPä¸­åŠ å…¥ARåŠŸèƒ½ï¼Œæ‰«æå¡é¢äºŒç»´ç å¯å±•ç¤ºä¼˜æƒ æˆ–äº’åŠ¨æ¸¸æˆï¼Œå¢åŠ ç”¨æˆ·ç²˜æ€§ã€‚</li><li><strong>è·¨å“ç‰Œåˆä½œ</strong>ï¼šæ‰“é€ é€šç”¨å‚¨å€¼å¡ç”Ÿæ€ï¼Œä¸é¤é¥®ã€å¨±ä¹ç­‰è¡Œä¸šåˆä½œï¼Œæ‰©å±•ä½¿ç”¨åœºæ™¯ã€‚</li></ul><h2 id=æœªæ¥å±•æœ›æ•°å­—åŒ–æ”¯ä»˜çš„æ— é™å¯èƒ½>æœªæ¥å±•æœ›ï¼šæ•°å­—åŒ–æ”¯ä»˜çš„æ— é™å¯èƒ½<a hidden class=anchor aria-hidden=true href=#æœªæ¥å±•æœ›æ•°å­—åŒ–æ”¯ä»˜çš„æ— é™å¯èƒ½>#</a></h2><p>äºŒç»´ç å‚¨å€¼å¡çš„æˆåŠŸè½åœ°æ ‡å¿—ç€é›¶å”®æ”¯ä»˜å‘ä½æˆæœ¬ã€æ•°å­—åŒ–æ–¹å‘è¿ˆå‡ºäº†é‡è¦ä¸€æ­¥ã€‚æœªæ¥ï¼Œéšç€5Gã€ç‰©è”ç½‘å’ŒåŒºå—é“¾æŠ€æœ¯çš„æ™®åŠï¼Œæˆ‘ä»¬ç›¸ä¿¡æ”¯ä»˜ç³»ç»Ÿå°†æ›´åŠ æ™ºèƒ½åŒ–å’Œæ— ç¼åŒ–ï¼š</p><ul><li><strong>å…¨åœºæ™¯æ”¯ä»˜</strong>ï¼šå‚¨å€¼å¡å°†æˆä¸ºè·¨è¡Œä¸šï¼ˆé¤é¥®ã€å¨±ä¹ã€äº¤é€šï¼‰çš„é€šç”¨æ”¯ä»˜å·¥å…·ã€‚</li><li><strong>æ— æ„Ÿæ”¯ä»˜</strong>ï¼šç»“åˆNFCå’Œç”Ÿç‰©è¯†åˆ«æŠ€æœ¯ï¼Œç”¨æˆ·åªéœ€é è¿‘è®¾å¤‡å³å¯å®Œæˆæ”¯ä»˜ã€‚</li><li><strong>ç»¿è‰²é‡‘è</strong>ï¼šé€šè¿‡ç”µå­å¡å’Œç¯ä¿ææ–™ï¼Œå‚¨å€¼å¡ç³»ç»Ÿå°†ä¸ºå¯æŒç»­å‘å±•è´¡çŒ®åŠ›é‡ã€‚</li></ul><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰“é€ ä¸€ä¸ªå®‰å…¨ã€ä¾¿æ·ã€å¯æŒç»­çš„æ”¯ä»˜ç”Ÿæ€ï¼Œè®©æ¯ä¸€ä½æ¶ˆè´¹è€…éƒ½èƒ½äº«å—åˆ°æ•°å­—åŒ–å¸¦æ¥çš„ä¾¿åˆ©ï¼ŒåŒæ—¶ä¸ºå•†å®¶åˆ›é€ æ›´å¤§ä»·å€¼ã€‚</p><hr><p><strong>ç»“è¯­</strong><br>ä»ç£æ¡åˆ°äºŒç»´ç ï¼Œä»å®ä½“å¡åˆ°ç”µå­é’±åŒ…ï¼Œæˆ‘ä»¬çš„å‚¨å€¼å¡è®¾è®¡æ­£åœ¨é‡å¡‘é›¶å”®æ”¯ä»˜çš„æœªæ¥ã€‚æˆ‘ä»¬æœŸå¾…é€šè¿‡æŒç»­åˆ›æ–°ï¼Œè®©æ”¯ä»˜æ›´ç®€å•ã€æ›´å®‰å…¨ã€æ›´æ™ºèƒ½ã€‚æ¬¢è¿ä½“éªŒè¿™ä¸€å…¨æ–°æ”¯ä»˜æ–¹å¼ï¼</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zisai.com/tags/%E6%94%AF%E4%BB%98%E5%88%9B%E6%96%B0/>æ”¯ä»˜åˆ›æ–°</a></li><li><a href=https://zisai.com/tags/%E4%BA%8C%E7%BB%B4%E7%A0%81/>äºŒç»´ç </a></li><li><a href=https://zisai.com/tags/%E5%82%A8%E5%80%BC%E5%8D%A1/>å‚¨å€¼å¡</a></li><li><a href=https://zisai.com/tags/%E9%87%91%E8%9E%8D%E7%A7%91%E6%8A%80/>é‡‘èç§‘æŠ€</a></li></ul><nav class=paginav><a class=prev href=https://zisai.com/posts/ios_version_jump/><span class=title>Â«</span><br><span>ä» iOS 18 åˆ° iOS 26ï¼šè‹¹æœä¸ºä½•è·³è¿‡ç‰ˆæœ¬å·ï¼Ÿ</span>
</a><a class=next href=https://zisai.com/posts/fix-l2tp-windows11/><span class=title>Â»</span><br><span>ä¿®å¤Windows 11ä¸‹L2TP/IPsec VPNè¿æ¥å¤±è´¥é—®é¢˜</span></a></nav></footer><script>const prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,storedTheme=localStorage.getItem("theme")||"auto",theme=storedTheme==="auto"?prefersDark?"github-dark":"github-light":storedTheme==="dark"?"github-dark":"github-light",script=document.createElement("script");script.src="https://utteranc.es/client.js",script.setAttribute("repo","Mythflair/zisai.com"),script.setAttribute("issue-term","pathname"),script.setAttribute("theme",theme),script.setAttribute("crossorigin","anonymous"),script.async=!0,document.currentScript.parentNode.insertBefore(script,document.currentScript)</script></article></main><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6505236094995924" crossorigin=anonymous></script><footer class=footer><span>&copy; 2025 <a href=https://zisai.com/>ç´«å¡ zisai.com</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>